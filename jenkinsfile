def remote = [:]
remote.name = 'vps'
remote.host = '185.97.144.204'
remote.allowAnyHosts = true

pipeline {
    agent any
    parameters {
        string(name: 'REPO_URL', defaultValue: 'https://github.com/saber0amine/HashiCorp_vault_Spring_MicroService.git', description: 'Git repository URL')
        string(name: 'BRANCH', defaultValue: 'master', description: 'Git branch to build')
    }

    environment {
        VAULT_ADDR = 'http://185.97.144.204:8200'
        VAULT_SCRIPT_PATH = '/home/secret_manager/hashiCorp_vault/vault_setup.sh'
    }

    stages {
        stage('Checkout') {
            steps {
                cleanWs()
                git branch: params.BRANCH, url: params.REPO_URL
            }
        }

        stage('Set up Vault') {
            steps {
                withCredentials([string(credentialsId: 'vault-unseal-key-1', variable: 'UNSEAL_KEY_1'),
                                 string(credentialsId: 'vault-unseal-key-2', variable: 'UNSEAL_KEY_2'),
                                 string(credentialsId: 'vault-unseal-key-3', variable: 'UNSEAL_KEY_3'),
                                 string(credentialsId: 'vault-root-token', variable: 'ROOT_TOKEN')]) {
                    sshCommand remote: remote, command: """
                        export VAULT_ADDR='http://127.0.0.1:8200'
                        chmod +x ${VAULT_SCRIPT_PATH}
                        ${VAULT_SCRIPT_PATH} ${UNSEAL_KEY_1} ${UNSEAL_KEY_2} ${UNSEAL_KEY_3} ${ROOT_TOKEN}
                    """
                }
            }
        }

        stage('Build Applications') {
            steps {
                dir('customer-front-thymeleaf-app') {
                    sh 'mvn clean package -DskipTests'
                }
                dir('inventory-service') {
                    sh 'mvn clean package -DskipTests'
                }
            }
        }

        stage('Deploy Applications') {
            steps {
                script {
                    sh """
                        VAULT_TOKEN=${env.VAULT_TOKEN} VAULT_ADDR=${VAULT_ADDR} \
                        java -jar customer-front-thymeleaf-app/target/customer-front-thymeleaf-app-0.0.1-SNAPSHOT.jar &
                    """
                    sh """
                        VAULT_TOKEN=${env.VAULT_TOKEN} VAULT_ADDR=${VAULT_ADDR} \
                        java -jar inventory-service/target/inventory-service-0.0.1-SNAPSHOT.jar &
                    """
                }
            }
        }
    }
}